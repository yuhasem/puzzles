import*as tt from"./draw.mjs";import{Coord as s,newColors as b,changeColors as j,pointToCell as d,coordToValue as B,valueToCoord as C,copy as E,adjacent as m,isValidCoord as p,colorsToSaveable as k,saveableToColors as q}from"./grid.mjs";import{EMPTY as J,BLOCK as K,LIGHT as L}from"./lights_enum.mjs";class it{constructor(t,s,e,i){this.selected=new Set,this.rows=t.length,this.columns=t[0].length,this.walls=t,this.clues=s,this.solution=e,i&&(this.state=JSON.parse(i),this.state)&&(this.state.colors=q(this.state.colors)),this.state||(this.state={input:rt(this.rows,this.columns),colors:b(this.rows,this.columns)}),this.stateUndo=[],this.stateRedo=[],this.won=!1}resetPuzzle(){this.selected.clear(),this.state={input:rt(this.rows,this.columns),colors:b(this.rows,this.columns)},this.stateUndo=[],this.stateRedo=[],this.won=!1}pushState(t){this.stateRedo=[],this.stateUndo.push(this.state),this.state=t}saveState(){return JSON.stringify({input:this.state.input,colors:k(this.state.colors)})}clearSelected(){this.selected.clear()}addToSelected(t,s){t=d(t,s);null!==t&&this.selected.add(B(t))}draw(t,e){t.clearRect(0,0,t.canvas.width,t.canvas.height),tt.drawLightWalls(t,this.walls);var i=((t,e)=>{for(var i=[],o=[],r=0;r<t.length;r++){for(var h=[],l=0;l<t[0].length;l++)h.push(!1);i.push(h)}for(r=0;r<t.length;r++)for(var a,l=0;l<t[0].length;l++)t[r][l]==L&&(a=!(i[r][l]=!0),a=(a=(a=(a|=ht(i,r,l,1,0,e,t))|ht(i,r,l,0,1,e,t))|ht(i,r,l,-1,0,e,t))|ht(i,r,l,0,-1,e,t))&&o.push(s(r,l));return{lit:i,errors:o}})(this.state.input,this.walls),o=(e||(i.errors=[]),[]);e&&(o=((t,e,i,o)=>{for(var r=[],h=0;h<t.length;h++)for(var l=0;l<t[0].length;l++)if(""!=t[h][l]){var a=s(h,l);if("number"==typeof t[h][l]){var n=0,c=(.1<Math.sin(t[h][l])?n=-1:Math.sin(t[h][l])<.1&&(n=1),0);.1<Math.cos(t[h][l])?c=1:Math.cos(t[h][l])<.1&&(c=-1),(1<(c=((t,e,i,o,r,h)=>{for(var l=0,a=0;p(o);)e[o.row][o.col]||(t[o.row][o.col]==L?l++:i[o.row][o.col]||a++),o=s(o.row+h,o.col+r);return{lights:l,unlit:a}})(e,o,i,a,c,n)).lights||0==c.lights&&0==c.unlit)&&r.push(a)}else{var u,c=parseInt(t[h][l]),d=0,w=0;for(u of m(a))e[u.row][u.col]==L?d++:i[u.row][u.col]||w++;c<d&&r.push(a),w<c-d&&r.push(a)}}return r})(this.clues,this.state.input,i.lit,this.walls)),tt.drawLightClues(t,this.clues,o),tt.drawLightsInput(t,this.state.input,i.lit,i.errors),tt.drawGrid(t,this.rows,this.columns),tt.drawSelected(t,this.selected),tt.drawColors(t,this.state.colors)}allowsLines(){return!1}controls(){return[{text:"Light",class:"lights-control",keys:["KeyZ","Space"],method:function(t){t.placeLights()}},{text:"Block",class:"lights-control",keys:["KeyX"],method:function(t){t.blockCells()}}]}instructions(){return`
		<p>
		Select the "Controls" tab.  Select cells by clicking and draging across the grid.  Click "Light" or press "Z" or "Space" to place a light.  Click "Block" or press "X" to place a hint where lights cannot go.
		</p>
		<p>
		Holding "Shift" or "Ctrl" while clicking on the grid will add to the selected cells.
		</p>
		`}placeLights(){this.input(L,this.selected)}blockCells(){this.input(K,this.selected)}input(t,s){if(!this.won){var e,i=[],o=[];for(e of s){var r=C(e);this.walls[r.row][r.col]||(this.state.input[r.row][r.col]==J?(o.push(r),i.push(r)):this.state.input[r.row][r.col]==t&&o.push(r))}if(0<i.length){var h=E(this.state.input);for(e of i)h[e.row][e.col]=t;this.pushState({input:h,colors:this.state.colors})}else if(0<o.length){h=E(this.state.input);for(e of o)h[e.row][e.col]=J;this.pushState({input:h,colors:this.state.colors})}}}addColor(t){this.pushState({input:this.state.input,colors:j(this.state.colors,t,this.selected)})}undo(){0!=this.stateUndo.length&&(this.stateRedo.push(this.state),this.state=this.stateUndo.pop())}redo(){0!=this.stateRedo.length&&(this.stateUndo.push(this.state),this.state=this.stateRedo.pop())}hasWon(){for(var t=0;t<this.rows;t++)for(var s=0;s<this.columns;s++)if(this.solution[t][s]^this.state.input[t][s]==L)return!1;return this.won=!0}}function rt(t,s){for(var e=[],i=0;i<t;i++){for(var o=[],r=0;r<s;r++)o.push(J);e.push(o)}return e}function ht(t,e,i,o,r,h,l){for(var a=e+o,n=i+r;p(s(a,n))&&!h[a][n];){if(l[a][n]==L)return!0;t[a][n]=!0,a+=o,n+=r}return!1}export{it as LightHandler};