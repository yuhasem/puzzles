import*as tt from"./draw.mjs";import{Coord as s,newColors as b,changeColors as j,coordToValue as B,valueToCoord as C,copy as E,changeDimension as i,pointToEdgeOrCell as S,colorsToSaveable as k,saveableToColors as q}from"./grid.mjs";import{UNSET as N,BLOCK as K,TRACK as O}from"./trains_enum.mjs";class pt{constructor(t,s,e){this.solution=t,this.clues=s,this.rows=2+(s.body.length-1)/2,this.columns=2+(s.body[0].length-1)/2,this.won=!1,this.selected=new Set,e&&(this.state=JSON.parse(e),this.state)&&(this.state.colors=q(this.state.colors)),this.state||(this.state={input:vt(this.rows,this.columns),colors:b(this.rows,this.columns)}),this.stateUndo=[],this.stateRedo=[],i(2*this.columns+1,2*this.rows+1)}resetPuzzle(){this.won=!1,this.selected=new Set,this.state={input:vt(this.rows,this.columns),colors:b(this.rows,this.columns)},this.stateUndo=[],this.stateRedo=[]}pushState(t){this.stateRedo=[],this.stateUndo.push(this.state),this.state=t}undo(){0!=this.stateUndo.length&&(this.stateRedo.push(this.state),this.state=this.stateUndo.pop())}redo(){0!=this.stateRedo.length&&(this.stateUndo.push(this.state),this.state=this.stateRedo.pop())}saveState(){return JSON.stringify({input:this.state.input,colors:k(this.state.colors)})}hasWon(){if(!this.won){for(var t=0;t<this.solution.length;t++)for(var s=0;s<this.solution[0].length;s++)if(this.solution[t][s]==O&&this.state.input[t+3][s+3]!=O)return!1;this.won=!0}return!0}draw(t,e){t.clearRect(0,0,t.canvas.width,t.canvas.height);var o=mt(this.state.input,this.clues.body);tt.drawTrackCells(t,this.state.input,this.clues.body,o),tt.drawEdgeClues(t,this.clues),tt.drawGrid(t,this.rows,this.columns,1,this.rows-1,1,this.columns-1),tt.drawTrackEdges(t,this.state.input,this.clues.body),e&&tt.drawErrors(t,((t,e)=>{for(var o=mt(t,e.body),i=[],r=0;r<e.north.length;r++){var h=e.north[r],n=0;0<e.south[r]&&(h=e.south[r],n=(t.length-1)/2-1),0<h&&!((t,s,e)=>{for(var o=1;o<t.length;o+=2)if(t[o][s]==O&&--e,e<0)return;return 1})(o,2*(r+1)+1,h)&&i.push(s(n,r+1))}for(r=0;r<e.west.length;r++){var h=e.west[r],l=0;0<e.east[r]&&(h=e.east[r],l=(t[0].length-1)/2-1),0<h&&!((t,s,e)=>{for(var o=1;o<t[0].length;o+=2)if(t[s][o]==O&&e--,e<0)return;return 1})(o,2*(r+1)+1,h)&&i.push(s(r+1,l))}for(r=1;r<o.length;r+=2)for(var a=1;a<o[0].length;a+=2){var c,u=0;for(c of[[-1,0],[0,-1],[1,0],[0,1]])o[r+c[0]][a+c[1]]==O&&u++;2<u&&i.push(s((r-1)/2,(a-1)/2))}return i})(this.state.input,this.clues),this.rows,this.columns),tt.drawColors(t,this.state.colors),tt.drawCornerSelected(t,this.selected,this.rows,this.columns)}addToSelected(t,s){t=S(t,s);null!==t&&this.selected.add(B(t))}clearSelected(){this.selected.clear()}addColor(t){this.pushState({input:this.state.input,colors:j(this.state.colors,t,this.selected,!0)})}placeTrack(){var t,s=[],e=[];for(t of this.selected)if(wt(n=C(t),this.clues.body,this.rows,this.columns)){if(n.row%2==1&&n.col%2==0){var o=n.row,i=n.col-1;if(this.state.input[o][i]==K||this.clues.body[o-2][i-2]==K)continue;i=n.col+1;if(this.state.input[o][i]==K||this.clues.body[o-2][i-2]==K)continue}if(n.row%2==0&&n.col%2==1){o=n.col,i=n.row-1;if(this.state.input[i][o]==K||this.clues.body[i-2][o-2]==K)continue;var r=n.row+1;if(this.state.input[r][o]==K||this.clues.body[r-2][o-2]==K)continue}this.state.input[n.row][n.col]!=K&&s.push(n),this.state.input[n.row][n.col]==N&&e.push(n)}if(0!=s.length){if(0==e.length){var h=E(this.state.input);for(n of s)h[n.row][n.col]=N}else{var n,h=E(this.state.input);for(n of e)h[n.row][n.col]=O}this.pushState({input:h,colors:this.state.colors})}}blockTrack(){var t,s=[],e=[];for(t of this.selected)!wt(i=C(t),this.clues.body,this.rows,this.columns)||i.row%2==1&&i.col%2==1&&((t,s,e)=>{for(var o of[[-1,0],[0,-1],[1,0],[0,1]]){var i=t.row+o[0],o=t.col+o[1];if(s[i][o]==O||e[i-2][o-2]==O)return 1}})(i,this.state.input,this.clues.body)||(this.state.input[i.row][i.col]!=O&&s.push(i),this.state.input[i.row][i.col]==N&&e.push(i));if(0!=s.length){if(0==e.length){var o=E(this.state.input);for(i of s)o[i.row][i.col]=N}else{var i,o=E(this.state.input);for(i of e)o[i.row][i.col]=K}this.pushState({input:o,colors:this.state.colors})}}allowsLines(){return!1}controls(){return[{text:"Track",class:"trains-control",keys:["KeyZ","Space"],method:function(t){t.placeTrack()}},{text:"Block",class:"trains-control",keys:["KeyX"],method:function(t){t.blockTrack()}}]}instructions(){return`
		<p>
		Select the "Controls" tab.  Select cells and edges by clicking and draging across the grid.  Click "Track" or press "Z" to place tracks.  Click "Block" or press "X" to place a hint where tracks cannot go.
		</p>
		<p>
		Holding "Shift" or "Ctrl" while clicking on the grid will add to the selected cells and edges.
		</p>
		`}}function wt(t,s,e,o){return!(t.row<3||t.col<3||t.row>=2*e-2||t.col>=2*o-2||s[t.row-2][t.col-2]!=N||t.row%2==0&&t.col%2==0)}function vt(t,s){for(var e=[],o=0;o<2*t+1;o++){for(var i=[],r=0;r<2*s+1;r++)i.push(N);e.push(i)}return e}function mt(t,s){for(var e=[],o=0;o<t.length;o++){for(var i=[],r=0;r<t[0].length;r++)o<2||r<2||o>=2+s.length||r>=2+s[0].length?i.push(t[o][r]):i.push(s[o-2][r-2]==N?t[o][r]:s[o-2][r-2]);e.push(i)}return e}export{pt as TrainsHandler};