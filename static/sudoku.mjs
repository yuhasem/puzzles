import*as tt from"./draw.mjs";import{Coord as s,newColors as b,changeColors as j,pointToCell as d,coordToValue as B,valueToCoord as C,newLines as y,changeLines as z,getClosestCorner as A,NORTH as e,SOUTH as w,WEST as a,EAST as h,colorsToSaveable as k,saveableToColors as q}from"./grid.mjs";class dt{constructor(t,s,e,i,o){this.rows=t.length,this.columns=t[0].length,this.solution=t,this.digits=s,this.mode=0,this.cages=[];for(var r of e)this.cages.push(new ut(r.cells,r.sum));this.arrows=i,this.won=!1,this.selected=new Set,this.lastLineCoord=null,o&&(this.state=JSON.parse(o),this.state)&&(this.state.colors=q(this.state.colors),this.state.digits=(t=>{for(var s=[],e=0;e<t.length;e++){for(var i=[],o=0;o<t[0].length;o++){for(var r={final:t[e][o].final,inner:new Set,outer:new Set},l=0;l<t[e][o].inner.length;l++)r.inner.add(t[e][o].inner[l]);for(l=0;l<t[e][o].outer.length;l++)r.outer.add(t[e][o].outer[l]);i.push(r)}s.push(i)}return s})(this.state.digits)),this.state||(this.state={digits:ft(this.rows,this.columns),lines:y(this.rows,this.columns),colors:b(this.rows,this.columns)}),this.stateUndo=[],this.stateRedo=[]}resetPuzzle(){this.selected.clear(),this.lastLineCoord=null,this.won=!1,this.state={digits:ft(this.rows,this.columns),lines:y(this.rows,this.columns),colors:b(this.rows,this.columns)},this.stateUndo=[],this.stateRedo=[]}pushState(t){this.stateRedo=[],this.stateUndo.push(this.state),this.state=t}undo(){0!=this.stateUndo.length&&(this.stateRedo.push(this.state),this.state=this.stateUndo.pop())}redo(){0!=this.stateRedo.length&&(this.stateUndo.push(this.state),this.state=this.stateRedo.pop())}saveState(){return JSON.stringify({digits:(t=>{for(var s=[],e=0;e<t.length;e++){for(var i=[],o=0;o<t[0].length;o++){var r={final:t[e][o].final,inner:[],outer:[]};t[e][o].inner.forEach(t=>{r.inner.push(t)}),t[e][o].outer.forEach(t=>{r.outer.push(t)}),i.push(r)}s.push(i)}return s})(this.state.digits),lines:this.state.lines,colors:k(this.state.colors)})}hasWon(){if(!this.won){for(var t=0;t<this.solution.length;t++)for(var s=0;s<this.solution[0].length;s++)if(this.solution[t][s]!=this.state.digits[t][s].final)return!1;this.won=!0}return!0}draw(t,e){t.clearRect(0,0,t.canvas.width,t.canvas.height),tt.drawGrid(t,this.rows,this.columns),tt.drawSudokuArrows(t,this.arrows,this.rows,this.columns),tt.drawCages(t,this.cages,this.rows,this.columns),e&&tt.drawErrors(t,(t=>{for(var e=[],i=0;i<t.length;i++)for(var o=0;o<t[0].length;o++)0<t[i][o].final&&((t,s,e)=>{for(var i=0;i<t.length;i++)if(i!=s&&t[i][e].final==t[s][e].final)return 1;for(i=0;i<t[0].length;i++)if(i!=e&&t[s][i].final==t[s][e].final)return 1})(t,i,o)&&e.push(s(i,o));return e})(this.state.digits),this.rows,this.columns),tt.drawSudokuDigits(t,this.state.digits),tt.drawLines(t,this.state.lines),tt.drawSelected(t,this.selected),tt.drawColors(t,this.state.colors)}addToSelected(t,s){t=d(t,s);null!==t&&this.selected.add(B(t))}changeMode(t){this.mode=t}placeDigit(t){if(!this.won)if(0==this.mode){if(0!=this.selected.size){var s=gt(this.state.digits);for(e of this.selected)s[(r=C(e)).row][r.col].final=t;this.pushState({digits:s,lines:this.state.lines,colors:this.state.colors})}}else{var e,i=[],o=[];for(e of this.selected){var r=C(e),l=(o.push(r),this.state.digits[r.row][r.col]);(1==this.mode&&!l.inner.has(t)||2==this.mode&&!l.outer.has(t))&&i.push(r)}if(0<i.length){s=gt(this.state.digits);for(r of i)1==this.mode?s[r.row][r.col].inner.add(t):2==this.mode&&s[r.row][r.col].outer.add(t);this.pushState({digits:s,lines:this.state.lines,colors:this.state.colors})}else if(0<o.length){s=gt(this.state.digits);for(r of o)1==this.mode?s[r.row][r.col].inner.delete(t):2==this.mode&&s[r.row][r.col].outer.delete(t);this.pushState({digits:s,lines:this.state.lines,colors:this.state.colors})}}}removeDigit(){var t=[],s=[];for(r of this.selected){var e=C(r),i=this.state.digits[e.row][e.col];0<i.final&&t.push(e),(1==this.mode&&0<i.inner.size||2==this.mode&&0<i.outer.size)&&s.push(e)}if(0<t.length){var o=gt(this.state.digits);for(e of t)o[e.row][e.col].final=0}else if(0<s.length){o=gt(this.state.digits);for(e of s)1==this.mode?o[e.row][e.col].inner.clear():2==this.mode&&o[e.row][e.col].outer.clear()}else{var r,o=gt(this.state.digits);for(r of this.selected)o[(e=C(r)).row][e.col].final=0,o[e.row][e.col].inner.clear(),o[e.row][e.col].outer.clear()}this.pushState({digits:o,lines:this.state.lines,colors:this.state.colors})}recordLine(t,s){t=A(t,s);null!==this.lastLineCoord&&(s=-1,t.row>this.lastLineCoord.row?s=w:t.row<this.lastLineCoord.row?s=e:t.col>this.lastLineCoord.col?s=h:t.col<this.lastLineCoord.col&&(s=a),-1!==s)&&this.pushState({digits:this.state.digits,lines:z(this.state.lines,this.lastLineCoord,s),colors:this.state.colors}),this.lastLineCoord=t}endLine(){this.lastLineCoord=null}clearSelected(){this.selected.clear()}addColor(t){this.pushState({digits:this.state.digits,lines:this.state.lines,colors:j(this.state.colors,t,this.selected)})}allowsLines(){return!0}controls(){for(var t=[{text:"Place Final Digit",class:"sudoku-control",keys:["KeyZ"],method:function(t){t.changeMode(0)}},{text:"Place Hint Center Digit",class:"sudoku-control",keys:["KeyX"],method:function(t){t.changeMode(1)}},{text:"Place Hint Edge Digit",class:"sudoku-control",keys:["KeyC"],method:function(t){t.changeMode(2)}},{text:"Remove",class:"sudoku-remove",keys:["Backspace","Digit0","Numpad0"],method:function(t){t.removeDigit()}}],s=1;s<=9;s++)t.push({text:""+s,class:"sudoku-digit"+(s%3==0?"":" sudoku-float"),keys:["Digit"+s,"Numpad"+s],method:(s=>function(t){t.placeDigit(s)})(s)});return t}instructions(){return`
		<p>
		Select the "Controls" tab.  Select cells by clicking and draging across the grid.
		</p>
		<p>
		Holding "Shift" or "Ctrl" while clicking on the grid will add to the selected cells.
		</p>
		<p>
		Click "Place Final Digit" or press "Z" to place large digits in cells, that will be used to check the solution.  Click "Place Center Digit" or press "X" to place small digits in the center of a cell that can be used as hints.  Click "Place Hint Edge Digit" or press "C" to place small digits around the edge of a cell that can be used as hints.
		</p>
		<p>
		Press number keys to place digits in selected cells.  Click "Remove" or press "Backspace" to remove digits and hints from cells.
		</p>
		`}}class ut{constructor(t,e){this.sum=e,this.cells=[],this.upperLeft=s(100,100);for(var i of t)this.cells.push([i,tt.cageCell(i,t)]),(i.row<this.upperLeft.row||i.row==this.upperLeft.row&&i.col<this.upperLeft.col)&&(this.upperLeft=s(i.row,i.col))}}function ft(t,s){for(var e=[],i=0;i<t;i++){for(var o=[],r=0;r<s;r++)o.push({final:0,inner:new Set,outer:new Set});e.push(o)}return e}function gt(t){for(var s=[],e=0;e<t.length;e++){for(var i=[],o=0;o<t[0].length;o++){var r,l,h={final:t[e][o].final,inner:new Set,outer:new Set};for(r of t[e][o].inner)h.inner.add(r);for(l of t[e][o].outer)h.outer.add(l);i.push(h)}s.push(i)}return s}export{dt as SudokuHandler};