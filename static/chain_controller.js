import{resize as v}from"./grid.mjs";class Ie{constructor(e){this.context=e,v(e),this.mouseHold=!1,this.touchId=null,this.mode="controls",this.chainIndex=parseInt(window.localStorage.getItem("index")),this.chainIndex||(this.chainIndex=0),this.controls=[],this.next(!0),this.changeMode({target:{id:"control"}})}setControls(e,t,n){this.controls=e;var o,s,i=document.getElementById("control-tab");i.innerHTML="";for(o of e){var l=document.createElement("button");l.innerText=o.text,l.className=o.class,l.onclick=(e=>function(){controller.execute(e.method)})(o),i.appendChild(l)}for(s of document.getElementsByTagName("label"))switch(s.attributes.for.nodeValue){case"control":s.style.display=0<e.length?"":"none";break;case"color":s.style.display=t?"":"none";break;case"line":s.style.display=n?"":"none"}}resetPuzzle(){this.handler.resetPuzzle(),this.draw(this.context)}draw(){this.handler.draw(this.context,document.getElementById("highlight-errors").checked)}addColor(e){this.handler.addColor(e),this.save(),this.draw()}redo(){this.handler.redo(),this.draw()}undo(){this.handler.undo(),this.draw()}click(e){var t;this.mouseHold=!0,"line"===this.mode?(t=He(e),this.handler.recordLine(t.x,t.y),this.draw()):"puzzle"!=e.target.id?console.log("non puzzle click?"):(e.ctrlKey||e.shiftKey||this.handler.clearSelected(),t=He(e),this.handler.addToSelected(t.x,t.y),this.draw())}touch(e){if(console.log("touch"),console.log(e),console.log("last touch "+this.touchId),null===this.touchId){e.preventDefault();for(var t of e.changedTouches){this.touchId=t.identifier,this.click({target:e.target,ctrlKey:!1,shiftKey:!1,clientX:t.pageX,clientY:t.pageY});break}console.log("now touch "+this.touchId)}}move(e){this.mouseHold&&(e=He(e),"line"===this.mode?(this.handler.recordLine(e.x,e.y),this.handler.hasWon()&&this.win()):this.handler.addToSelected(e.x,e.y),this.draw())}touchMove(e){console.log("touch move"),console.log(e),e.preventDefault();for(var t of e.changedTouches)console.log("touch move "+t.identifier),t.identifier===this.touchId&&(console.log("calling move"),this.move({target:e.target,clientX:t.pageX,clientY:t.pageY}))}unclick(){this.mouseHold=!1,"line"===this.mode&&this.handler.endLine()}touchEnd(e){console.log("touch end"),this.touchId=null,this.unclick()}key(e){if(e.ctrlKey&&"KeyZ"==e.code||"KeyU"==e.code)this.undo();else if(e.ctrlKey&&"KeyY"==e.code||"KeyR"==e.code)this.redo();else for(var t of this.controls)for(var n of t.keys)e.code==n&&this.execute(t.method)}execute(e){e(this.handler),this.handler.hasWon()&&this.win(),this.save(),this.draw()}win(){var e=document.getElementById("message");e.innerHTML="Congratulations, you won!",e.style.display="",this.chainIndex<chain.length-1&&(document.getElementById("next").disabled=!1)}next(e){document.getElementById("next").disabled=!0;var t=document.getElementById("message"),n=(t.innerHTML="",t.style.display="none",""),o=(e?n=window.localStorage.getItem("state"):this.chainIndex++,chain[this.chainIndex]),n=(document.getElementById("rules").innerHTML=o.rules,"");switch(e&&(n=window.localStorage.getItem("state")),o.type){case"MINES":import("./mines.mjs").then(e=>{this.handler=new e.MineHandler(o.clues,o.specials,n),this.setNext()});break;case"LIGHTS":import("./lights.mjs").then(e=>{this.handler=new e.LightHandler(o.walls,o.clues,o.solution,n),this.setNext()});break;case"GALAXIES":import("./galaxies.mjs").then(e=>{this.handler=new e.GalaxyHandler(o.clues,o.solution,o.specials,n),this.setNext()});break;case"SUDOKU":import("./sudoku.mjs").then(e=>{this.handler=new e.SudokuHandler(o.solution,o.digits,o.cages,o.arrows,n),this.setNext()});break;case"TRAINS":import("./trains.mjs").then(e=>{this.handler=new e.TrainsHandler(o.solution,o.clues,n),this.setNext()})}}setNext(){this.setControls(this.handler.controls(),!0,this.handler.allowsLines()),document.getElementById("instructions").innerHTML=this.handler.instructions(),this.draw()}changeMode(e){this.mode=e.target.id;for(var t of document.getElementsByClassName("tab"))t.id===this.mode+"-tab"?t.style.display="":t.style.display="none"}save(){window.localStorage.setItem("index",this.chainIndex),window.localStorage.setItem("state",this.handler.saveState())}}function Ee(){window.innerHeight>window.innerWidth?document.getElementById("left").style.float="none":document.getElementById("left").style.float="left"}function He(e){var t=e.target.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}window.addEventListener("load",e=>{Ee(),controller=new Ie(document.getElementById("puzzle").getContext("2d"))}),window.addEventListener("resize",e=>{Ee(),v(document.getElementById("puzzle").getContext("2d"))}),window.addEventListener("mouseup",e=>{controller.unclick()}),window.addEventListener("touchend",e=>{controller.touchEnd(e)});