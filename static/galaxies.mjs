import*as tt from"./draw.mjs";import{Coord as s,newColors as b,changeColors as j,pointToCell as d,coordToValue as B,NORTH as e,SOUTH as w,WEST as a,EAST as h,getClosestCorner as A,newLines as y,changeLines as z,adjacentCellCoords as H,containsCoord as I,isValidCoord as p,adjacentCornerCoords as G,colorsToSaveable as k,saveableToColors as q}from"./grid.mjs";class st{constructor(t,s,o,e){this.centers=t,this.solution=s,this.clues=o,this.rows=(t.length-1)/2,this.columns=(t[0].length-1)/2,this.won=!1,this.selected=new Set,this.lastLineCoord=null,e&&(this.state=JSON.parse(e),this.state)&&(this.state.colors=q(this.state.colors)),this.state||(this.state={lines:y(this.rows,this.columns),colors:b(this.rows,this.columns)}),this.stateUndo=[],this.stateRedo=[]}resetPuzzle(){this.selected.clear(),this.lastLineCoord=null,this.won=!1,this.state={lines:y(this.rows,this.columns),colors:b(this.rows,this.columns)},this.stateUndo=[],this.stateRedo=[]}pushState(t){this.stateRedo=[],this.stateUndo.push(this.state),this.state=t}undo(){0!=this.stateUndo.length&&(this.stateRedo.push(this.state),this.state=this.stateUndo.pop())}redo(){0!=this.stateRedo.length&&(this.stateUndo.push(this.state),this.state=this.stateRedo.pop())}saveState(){return JSON.stringify({lines:this.state.lines,colors:k(this.state.colors)})}hasWon(){if(!this.won){for(var t=0;t<this.state.lines.length;t++)for(var s=0;s<this.state.lines[0].length;s++)if(this.state.lines[t][s]!=this.solution[t][s])return!1;this.won=!0}return!0}draw(t,o){t.clearRect(0,0,t.canvas.width,t.canvas.height),o&&tt.drawValid(t,((t,o)=>{for(var r=[],i=0;i<o.length;i++){for(var l=[],n=0;n<o[0].length;n++)l.push(!1);r.push(l)}for(i=0;i<t.length;i++)for(var c,n=0;n<t[0].length;n++)if(t[i][n])for(c of((t,o,r)=>{var i=!1,l=(3==t.row&&3==t.col&&(i=!1),H(t));i&&console.log(l);for(var n=0;n<l.length;n++)for(var c=0;c<l.length;c++)if(n!=c){if(l[n].row==l[c].row)if(l[n].col==l[c].col-1){if(!(r[l[n].row][l[n].col]&h))return[];if(!(r[l[c].row][l[c].col]&a))return[]}else if(l[n].col==l[c].col+1){if(!(r[l[n].row][l[n].col]&a))return[];if(!(r[l[c].row][l[c].col]&h))return[]}if(l[n].col==l[c].col)if(l[n].row==l[c].row-1){if(!(r[l[n].row][l[n].col]&w))return[];if(!(r[l[c].row][l[c].col]&e))return[]}else if(l[n].col==l[c].col+1){if(!(r[l[n].row][l[n].col]&e))return[];if(!(r[l[c].row][l[c].col]&w))return[]}}i&&console.log("passed lines over center test");var d,u=[];for(d of l)u.push(d);for(;0!=u.length;){var f,g=u.pop();for(f of ot){var v=s(g.row+f.row,g.col+f.col);if(i&&console.log("evaluating <"+v.row+", "+v.col+">"),I(l,v))i&&console.log("dropping because already in");else if(p(v)){if(0!=(r[g.row][g.col]&f.dir)&&I(l,v))return i&&console.log("past "+f.dir+"edge is also part of enclosure"),[];if(0==(r[g.row][g.col]&f.dir)&&!I(l,v)){var L=((t,o)=>s(o.row-t.row-1,o.col-t.col-1))(v,t);if(i&&console.log("evaluating opposite <"+L.row+", "+L.col+">"),!p(L))return i&&console.log("opp outside of grid, invalid"),[];if(0!=(r[L.row][L.col]&f.dir))return i&&console.log("past "+f.dir+" expansion is not valid"),[];if(0==(r[L.row][L.col]&f.dir)){if(et(v,o)||et(L,o))return i&&console.log("other galaxy center is adjacent"),[];l.push(v),l.push(L),u.push(v),u.push(L)}}}else i&&console.log("outside of grid")}}return i&&console.log(l),l})(s(i,n),t,o))r[c.row][c.col]=!0;return r})(this.centers,this.state.lines)),tt.drawGrid(t,this.rows,this.columns),tt.drawCenters(t,this.centers),tt.drawGalaxyArrows(t,this.clues,this.rows,this.columns),tt.drawLines(t,this.state.lines),tt.drawSelected(t,this.selected),tt.drawColors(t,this.state.colors)}addToSelected(t,s){t=d(t,s);null!==t&&this.selected.add(B(t))}recordLine(t,s){t=A(t,s);null!==this.lastLineCoord&&(s=-1,t.row>this.lastLineCoord.row?s=w:t.row<this.lastLineCoord.row?s=e:t.col>this.lastLineCoord.col?s=h:t.col<this.lastLineCoord.col&&(s=a),-1!==s)&&this.pushState({lines:z(this.state.lines,this.lastLineCoord,s),colors:this.state.colors}),this.lastLineCoord=t}endLine(){this.lastLineCoord=null}clearSelected(){this.selected.clear()}addColor(t){this.pushState({lines:this.state.lines,colors:j(this.state.colors,t,this.selected)})}allowsLines(){return!0}controls(){return[]}instructions(){return`
		<p>
		Select the "Line" tab.  Click and drag along grid lines to turn them on/off.  When a region is a valid galaxy, it becomes shaded grey.
		</p>
		`}}var ot=[{dir:e,row:-1,col:0,opp:w},{dir:a,row:0,col:-1,opp:h},{dir:w,row:1,col:0,opp:e},{dir:h,row:0,col:1,opp:a}];function et(t,s){var o;for(o of G(t))if(s[o.row][o.col])return 1}export{st as GalaxyHandler};